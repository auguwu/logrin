#!/usr/bin/env bash
# +---------------------------------------------------------------------------------+
# üêª‚Äç‚ùÑÔ∏èüè≥Ô∏è‚Äç‚ößÔ∏è Logrin: Modern, async-aware logging framework for C++20
# Copyright (c) 2026 Noel Towa <cutie@floofy.dev>, et al.
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
# +----------------------------------------------------------------------------------

SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")/.." &> /dev/null && pwd)
VERSION=$(cat "$SCRIPT_DIR/.logrin-version")

echo "[logrin/tools:bazeldist] Preparing Bazel distribution..."

[ -d "$SCRIPT_DIR/.bazeldist" ] && rm -rf "$SCRIPT_DIR/.bazeldist" || true

# Create a directory in the script directory so that
# we can copy files into this for the final tarball
mkdir -p "$SCRIPT_DIR/.bazeldist"

dirs=(
    "bazel"
    "include"
    "src"
    "tests"
    "patches"
)

files=(
    ".logrin-version"
    "BUILD.bazel"
    "dummy.cc"
    "README.md"
    "LICENSE"
)

for dir in "${dirs[@]}"; do
    echo "[logrin/tools:bazeldist] copying directory $dir ~> $SCRIPT_DIR/.bazeldist/$dir"
    cp -r "$SCRIPT_DIR/$dir" "$SCRIPT_DIR/.bazeldist"

    if [ "$dir" == "bazel" ]; then
        rm -rf "$SCRIPT_DIR/.bazeldist/bazel/deps"

        version=$(cat "$SCRIPT_DIR/.logrin-version")
        sed -i "s/^VERSION = \".*\"/VERSION = \"$version\"/" "$SCRIPT_DIR/.bazeldist/bazel/version.bzl"
    fi

    if [ "$dir" == "patches" ]; then
        rm "$SCRIPT_DIR/.bazeldist/patches/000_hedron_compile_commands__fix_assertion.patch"
    fi
done

for file in "${files[@]}"; do
    echo "[logrin/tools:bazeldist] copying file $file ~> $SCRIPT_DIR/.bazeldist/$file"
    cp -f "$SCRIPT_DIR/$file" "$SCRIPT_DIR/.bazeldist"
done

echo "[logrin/tools:bazeldist] rebuilding \`MODULE.bazel\`..."

cat <<EOF > "$SCRIPT_DIR/.bazeldist/MODULE.bazel"
# üêª‚Äç‚ùÑÔ∏èüè≥Ô∏è‚Äç‚ößÔ∏è Logrin: Modern, async-aware logging framework for C++20
# Copyright (c) 2026 Noel Towa <cutie@floofy.dev>, et al.
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

module(
    name = "logrin",
    version = "$VERSION",
    compatibility_level = 0,
    repo_name = "dev_floofy_logrin",
)

EOF

deps=(
    "bazel/deps/bzl.MODULE.bazel"
    "bazel/deps/cc.MODULE.bazel"
)

for depfile in "${deps[@]}"; do
    awk '
        FNR==1 { skipping = 1 }
        skipping && (/^#/ || /^$/) { next }
        skipping { skipping = 0 }
        { print } ENDFILE { print "" }
    ' "$SCRIPT_DIR/$depfile" >> "$SCRIPT_DIR/.bazeldist/MODULE.bazel"
done

awk '
  /^load\("@hedron_compile_commands\/\// { next }
  /^refresh_compile_commands\(/ { s=1 }
  s && /^\)/ { s=0; next }
  !s
' "$SCRIPT_DIR/BUILD.bazel" > "$SCRIPT_DIR/.bazeldist/BUILD.bazel"

if command -v buildifier >/dev/null; then
    buildifier -mode fix "$SCRIPT_DIR/.bazeldist/MODULE.bazel"
    buildifier -mode fix "$SCRIPT_DIR/.bazeldist/BUILD.bazel"
fi

echo "[logrin/tools:bazeldist] repackaging \`.bazeldist\` as a tarball file with a determinstic timestamp"
GZIP=-n tar \
  -C "$SCRIPT_DIR/.bazeldist" \
  --mtime='@0' \
  --sort=name \
  --owner=0 --group=0 --numeric-owner \
  -czvf "$SCRIPT_DIR/dist.tgz" \
  .
